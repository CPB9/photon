from __future__ import print_function

import argparse
import glob
import sys
import os

sources = [@PHOTON_ADDITIONAL_SOURCES_LIST@]
prefixes = ['src', '@CMAKE_CURRENT_SOURCE_DIR@/src', '_gen_src'] #HACK

def process_all_headers(outfile, processed=set()):
    flist = []
    for prefix in prefixes:
        flist += glob.glob(prefix + '/**/*.h', recursive=True)
    for fname in flist:
        process_header(fname, outfile, processed)

def process_header(fname, outfile, processed=set()):
    outfile.write("#define PHOTON_AMALGAMATION\n\n")
    relname = 'photon' + fname.split('photon')[1]
    processed.add(relname)
    f = open(fname, 'r')
    for line in f.readlines():
        if line[0:8] == '#include':
            header = line[9:].strip('\r\n\t \"<>')
            if header[0:6] == 'photon':
                if not header in processed:
                    for prefix in prefixes:
                        fname = prefix + '/' + header
                        if os.path.isfile(fname):
                            process_header(fname, outfile, processed)
            else:
                outfile.write(line)
        else:
            outfile.write(line)
    outfile.write('\n')

def process_all_sources(outfile, header_name='photon.h'):
    outfile.write('#include \"' + header_name + '\"\n')
    plist = []
    for prefix in prefixes:
        for fname in glob.glob(prefix + '/**/*Private.inc.c', recursive=True):
            plist.append(fname)
            f = open(fname, 'r')
            outfile.write(f.read())
            outfile.write('\n')
    flist = []
    for prefix in prefixes:
        flist += glob.glob(prefix + '/**/*.c', recursive=True)
    flist += sources
    for fname in flist:
        if fname not in plist:
            f = open(fname, 'r')
            for line in f.readlines():
                if line[0:8] == '#include':
                    header = line[9:].strip('\r\n\t \"<>')
                    if not header[0:6] == 'photon':
                        outfile.write(line)
                else:
                    outfile.write(line)
            outfile.write('\n#undef _PHOTON_FNAME\n')
    outfile.write('\n')

if not os.path.exists('amalgamation'):
    os.makedirs('amalgamation')
process_all_headers(open('@PHOTON_AMALGAMATION_DEST@/photon.h', 'w'))
process_all_sources(open('@PHOTON_AMALGAMATION_DEST@/photon.c', 'w'))
